- 对于资源受限的平台可以将 Lua 5.3 编译为精简 Lua 模式，通过添加 LUA_32BITS 宏定义，该模式除了占用字节不同以外和标准 Lua 是一样的

### 3.1 数值常量

- Lua5.2 及以前版本中，所有的数值以双精度浮点格式表示。Lua5.3 开始将数值格式变为了称为 integer 的 64 位整数类型和称为 float 的双精度浮点类型，其中具有十进制小数或指数的数值会被当作浮点数，否则是整数值，它们的类型都是 number，若要区分两种类型可以使用 math.type 返回对应类型字符串。

- Lua 支持的数值常量：

  - 科学计数法，可选的十进制部分加一个可选的指数部分：

    ```lua
    4.57e-3
    ```

  - 以 0x 开头的十六进制常量，支持十六进制浮点数（lua5.2 版本引入），由可选的整数部分、小数部分和以 p 或 P 开头的指数部分组成：

    ```lua
    0xa.bp-1
    ```

    通过函数 string.format 以及 %a 参数输出十六进制浮点数，该格式可以保留所有浮点数的精度且比十进制转换速度更快：

    ```lua
    string.format("%a", 419)
    ```

### 3.2 算术运算

- Lua 支持的算术运算：

  - 加、减、乘、、取负数：两个整型值进行这些运算的结果仍然是整型，若存在不是整型的操作数则结果是浮点数，但除非发生溢出，它们的结果表示的数值相同。

  - 除：两个整型相除的结果不一定为整数，所以为避免整数值相除和浮点数相除导致不一样的结果，所以除法操作数永远是浮点型且产生浮点值。

  - floor 除法：Lua5.3 针对整数除法引入的，其对得到的商向负无穷取整，保证结果是一个整数。所以若操作数都是整型则结果为整型，否则为浮点型。

  - 取模：运算结果的符号永远是第二个操作数的符号。两个整型值进行这些运算的结果仍然是整型，若存在不是整型的操作数则结果是浮点数。有用的技巧：

    ```lua
    -- 保留 n 位小数 
    x - x % (0.1 ^ n)
    ```

  - 幂运算：用符号 ^ 表示，由于两个整数的幂运算不一定是整数（负数幂），所以其操作数和结果永远都是浮点类型

### 3.3 关系运算

- Lua 语言的关系运算：

  ```lua
  <	>	<=	>=	==	~=
  ```

  所有的结果都是 boolean 类型。比较数值时永远忽略两者数值的子类型（整型、浮点型），只与算术值有关，但相同子类型效率更高

  其中 == 和 ~= 可用于任意两个值，当它们类型不同时则不相等，若类型相同再对两者值进行比较。

### 3.4 数学库

- Lua 提供了标准数学库 math，由一组数学函数组成：

  - 三角函数（以弧度为单位）、弧度和角度的转换 deg（弧度转角度）和 rad（角度转弧度）、指数函数、max 和 min、常量 pi 和 huge（最大可表示数值，大多数平台代表 inf）

  - 取整函数：floor（向负无穷取整）、ceil（向正无穷取整）、modf（向零取整）。当取整结果能够用整型表示时，返回结果为整型值，否则返回用科学计数法表示的浮点型值。modf 还会返回小数部分作为第二个结果。

  - 伪随机数函数：random。有三种调用方式：

    1. 不带参数：返回 [0, 1) 内均匀分布的伪随机实数
    2. 带一个整数值 n：返回 [1, n] 范围内的伪随机整数
    3. 带两个整数 l、r：返回 [l, r] 范围内的伪随机整数

    函数 randomseed 用于设置伪随机数发生器的种子，其唯一参数为数值类型的种子。在程序启动时，系统固定使用种子 1 初始化伪随机数发生器。

### 3.5 表示范围

- 对于整数，标准 Lua 使用 64 个比特存储整型值，精简 Lua 使用 32 个比特位存储。数学库定义了整型的最大值 maxinteger 和最小值 mininteger。

  对于浮点数，标准 Lua 使用双精度，其中 11 个指数位，精简 Lua 使用单精度

  对于比较大的整数和浮点数进行加法时，由于整型和浮点型的溢出机制不一致，所以和某个整数相加相比和某个浮点数相加会导致不一致的结果。

### 3.6 惯例

- 一些有用的技巧：

  - 通过增加 0.0 的方法将整数转为浮点型值，对于小于等于 2^53^ 的所有整数值的表示与双精度浮点值一样，若超过该值转换为浮点型时可能导致精度丢失

  - 与 0 进行按位或运算可以将浮点型强制转换为整型，此时，Lua 会检查数值是否与整型值表示完全一致，若不满足条件则抛出异常，对小数部分有值的数值必须显式调用取整函数。

    另一种将浮点型转换为整型的方法是使用函数 math.tointeger，在无法转换时会返回 nil

### 3.7 运算符优先级

- 运算符优先级从高到低：

  1. ^
  2. -、#、~、not（一元运算符）
  3. *、/、//、%
  4. +、-
  5. ..（连接）
  6. << >>
  7. &
  8. ~
  9. |
  10. <、>、<=、>=、~=、==
  11. and
  12. or

  二元运算符中，除了幂预算和连接操作符是右结合，其他都是左结合的

### 3.8 兼容性

- Lua5.2 支持的最大整数为 2^53^，而 Lua5.3 支持的最大整数为 2^63^。当把整型值作为通用比特位使用时该区别可能比较重要。

  Lua5.2 在某些情形下没有约定浮点型和整形之间的转化方法，文档中只说数值会以某种不确定的方式被截断，导致不同平台上结果不同。而 Lua5.3 明确了转换规则

  Lua5.2 没有提供库函数中与整型相关的函数和常量，也没有 floor 除法（其和取模运算基本等价）

